"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.adapterFactory = exports.CucumberAdapter = void 0;
const path_1 = __importDefault(require("path"));
const events_1 = require("events");
const mockery_1 = __importDefault(require("mockery"));
const is_glob_1 = __importDefault(require("is-glob"));
const glob_1 = __importDefault(require("glob"));
const Cucumber = __importStar(require("@cucumber/cucumber"));
const GherkinStreams_1 = __importDefault(require("@cucumber/gherkin/dist/src/stream/GherkinStreams"));
const event_data_collector_1 = __importDefault(require("@cucumber/cucumber/lib/formatter/helpers/event_data_collector"));
const messages_1 = require("@cucumber/messages");
const utils_1 = require("@wdio/utils");
const reporter_1 = __importDefault(require("./reporter"));
const constants_1 = require("./constants");
const utils_2 = require("./utils");
const { incrementing } = messages_1.IdGenerator;
class CucumberAdapter {
    constructor(_cid, _config, _specs, _capabilities, _reporter) {
        this._cid = _cid;
        this._config = _config;
        this._specs = _specs;
        this._capabilities = _capabilities;
        this._reporter = _reporter;
        this._cwd = process.cwd();
        this._newId = incrementing();
        this._cucumberOpts = Object.assign({}, constants_1.DEFAULT_OPTS, this._config.cucumberOpts);
        this._hasTests = true;
        this._cucumberFeaturesWithLineNumbers = this._config.cucumberFeaturesWithLineNumbers || [];
        this._eventBroadcaster = new events_1.EventEmitter();
        this._eventDataCollector = new event_data_collector_1.default(this._eventBroadcaster);
        const featurePathsToRun = this._cucumberFeaturesWithLineNumbers.length > 0 ? this._cucumberFeaturesWithLineNumbers : this._specs;
        this._pickleFilter = new Cucumber.PickleFilter({
            cwd: this._cwd,
            featurePaths: featurePathsToRun,
            names: this._cucumberOpts.names,
            tagExpression: this._cucumberOpts.tagExpression
        });
        const reporterOptions = {
            capabilities: this._capabilities,
            ignoreUndefinedDefinitions: Boolean(this._cucumberOpts.ignoreUndefinedDefinitions),
            failAmbiguousDefinitions: Boolean(this._cucumberOpts.failAmbiguousDefinitions),
            tagsInTitle: Boolean(this._cucumberOpts.tagsInTitle),
            scenarioLevelReporter: Boolean(this._cucumberOpts.scenarioLevelReporter)
        };
        this._cucumberReporter = new reporter_1.default(this._eventBroadcaster, this._pickleFilter, reporterOptions, this._cid, this._specs, this._reporter);
    }
    async init() {
        try {
            const gherkinMessageStream = GherkinStreams_1.default.fromPaths(this._specs, {
                defaultDialect: this._cucumberOpts.featureDefaultLanguage,
                newId: this._newId
            });
            await Cucumber.parseGherkinMessageStream({
                cwd: this._cwd,
                eventBroadcaster: this._eventBroadcaster,
                gherkinMessageStream,
                eventDataCollector: this._eventDataCollector,
                order: this._cucumberOpts.order,
                pickleFilter: this._pickleFilter
            });
            this._hasTests = this._cucumberReporter.eventListener.getPickleIds(this._capabilities).length > 0;
        }
        catch (runtimeError) {
            await utils_1.executeHooksWithArgs('after', this._config.after, [runtimeError, this._capabilities, this._specs]);
            throw runtimeError;
        }
        /**
         * import and set options for `expect-webdriverio` assertion lib once
         * the framework was initiated so that it can detect the environment
         */
        const { setOptions } = require('expect-webdriverio');
        setOptions({
            wait: this._config.waitforTimeout,
            interval: this._config.waitforInterval,
        });
        return this;
    }
    hasTests() {
        return this._hasTests;
    }
    async run() {
        let runtimeError;
        let result;
        try {
            this.registerRequiredModules();
            Cucumber.supportCodeLibraryBuilder.reset(this._cwd, this._newId);
            /**
             * wdio hooks should be added before spec files are loaded
             */
            this.addWdioHooks(this._config);
            this.loadSpecFiles();
            this.wrapSteps(this._config);
            /**
             * we need to somehow identify is function is step or hook
             * so we wrap every user hook function
             */
            utils_2.setUserHookNames(Cucumber.supportCodeLibraryBuilder);
            Cucumber.setDefaultTimeout(this._cucumberOpts.timeout);
            const supportCodeLibrary = Cucumber.supportCodeLibraryBuilder.finalize();
            /**
             * gets current step data: `{ uri, feature, scenario, step, sourceLocation }`
             * or `null` for some hooks.
             */
            this.getHookParams = this._cucumberReporter
                .eventListener
                .getHookParams
                .bind(this._cucumberReporter.eventListener);
            const runtime = new Cucumber.Runtime({
                newId: this._newId,
                eventBroadcaster: this._eventBroadcaster,
                options: this._cucumberOpts,
                supportCodeLibrary,
                eventDataCollector: this._eventDataCollector,
                pickleIds: this._cucumberReporter.eventListener.getPickleIds(this._capabilities)
            });
            result = await runtime.start() ? 0 : 1;
            /**
             * if we ignore undefined definitions we trust the reporter
             * with the fail count
             */
            if (this._cucumberOpts.ignoreUndefinedDefinitions && result) {
                result = this._cucumberReporter.failedCount;
            }
        }
        catch (e) {
            runtimeError = e;
            result = 1;
        }
        await utils_1.executeHooksWithArgs('after', this._config.after, [runtimeError || result, this._capabilities, this._specs]);
        /**
         * in case the spec has a runtime error throw after the wdio hook
         */
        if (runtimeError) {
            throw runtimeError;
        }
        return result;
    }
    /**
     * Transpilation https://github.com/cucumber/cucumber-js/blob/master/docs/cli.md#transpilation
     * Usage: `['module']`
     * we extend it a bit with ability to init and pass configuration to modules.
     * Pass an array with path to module and its configuration instead:
     * Usage: `[['module', {}]]`
     * Or pass your own function
     * Usage: `[() => { require('@babel/register')({ ignore: [] }) }]`
     */
    registerRequiredModules() {
        this._cucumberOpts.requireModule.map(requiredModule => {
            if (Array.isArray(requiredModule)) {
                require(requiredModule[0])(requiredModule[1]);
            }
            else if (typeof requiredModule === 'function') {
                requiredModule();
            }
            else {
                require(requiredModule);
            }
        });
    }
    requiredFiles() {
        return this._cucumberOpts.require.reduce((files, requiredFile) => files.concat(is_glob_1.default(requiredFile)
            ? glob_1.default.sync(requiredFile)
            : [requiredFile]), []);
    }
    loadSpecFiles() {
        // we use mockery to allow people to import 'our' cucumber even though their spec files are in their folders
        // because of that we don't have to attach anything to the global object, and the current cucumber spec files
        // should just work with no changes with this framework
        mockery_1.default.enable({
            useCleanCache: false,
            warnOnReplace: false,
            warnOnUnregistered: false
        });
        mockery_1.default.registerMock('@cucumber/cucumber', Cucumber);
        this.requiredFiles().forEach((codePath) => {
            const filepath = path_1.default.isAbsolute(codePath)
                ? codePath
                : path_1.default.join(process.cwd(), codePath);
            // This allows rerunning a stepDefinitions file
            delete require.cache[require.resolve(filepath)];
            require(filepath);
        });
        mockery_1.default.disable();
    }
    /**
     * set `beforeScenario`, `afterScenario`, `beforeFeature`, `afterFeature`
     * @param {object} config config
     */
    addWdioHooks(config) {
        var _a;
        const eventListener = (_a = this._cucumberReporter) === null || _a === void 0 ? void 0 : _a.eventListener;
        Cucumber.BeforeAll(async function wdioHookBeforeFeature() {
            const params = eventListener === null || eventListener === void 0 ? void 0 : eventListener.getHookParams();
            await utils_1.executeHooksWithArgs('beforeFeature', config.beforeFeature, [params === null || params === void 0 ? void 0 : params.uri, params === null || params === void 0 ? void 0 : params.feature]);
        });
        Cucumber.AfterAll(async function wdioHookAfterFeature() {
            const params = eventListener === null || eventListener === void 0 ? void 0 : eventListener.getHookParams();
            await utils_1.executeHooksWithArgs('afterFeature', config.afterFeature, [params === null || params === void 0 ? void 0 : params.uri, params === null || params === void 0 ? void 0 : params.feature]);
        });
        Cucumber.Before(async function wdioHookBeforeScenario(world) {
            await utils_1.executeHooksWithArgs('beforeScenario', config.beforeScenario, [world]);
        });
        Cucumber.After(async function wdioHookAfterScenario(world) {
            await utils_1.executeHooksWithArgs('afterScenario', config.afterScenario, [world]);
        });
    }
    /**
     * wraps step definition code with sync/async runner with a retry option
     * @param {object} config
     */
    wrapSteps(config) {
        const wrapStep = this.wrapStep;
        const cid = this._cid;
        const getHookParams = () => this.getHookParams && this.getHookParams();
        Cucumber.setDefinitionFunctionWrapper((fn, options = { retry: 0 }) => {
            /**
             * hooks defined in wdio.conf are already wrapped
             */
            if (fn.name.startsWith('wdioHook')) {
                return fn;
            }
            /**
             * this flag is used to:
             * - avoid hook retry
             * - avoid wrap hooks with beforeStep and afterStep
             */
            const isStep = !fn.name.startsWith('userHook');
            return wrapStep(fn, isStep, config, cid, options, getHookParams);
        });
    }
    /**
     * wrap step definition to enable retry ability
     * @param   {Function}  code            step definition
     * @param   {Number}    retryTest       amount of allowed repeats is case of a failure
     * @param   {boolean}   isStep
     * @param   {object}    config
     * @param   {string}    cid             cid
     * @param   {Function}  getHookParams  step definition
     * @return  {Function}                  wrapped step definition for sync WebdriverIO code
     */
    wrapStep(code, isStep, config, cid, options, getHookParams) {
        return function (...args) {
            const hookParams = getHookParams();
            const retryTest = isStep && isFinite(options.retry) ? options.retry : 0;
            /**
             * wrap user step/hook with wdio before/after hooks
             */
            const beforeFn = isStep ? config.beforeStep : config.beforeHook;
            const afterFn = isStep ? config.afterStep : config.afterHook;
            return utils_1.testFnWrapper.call(this, isStep ? 'Step' : 'Hook', { specFn: code, specFnArgs: args }, { beforeFn: beforeFn, beforeFnArgs: (context) => [hookParams === null || hookParams === void 0 ? void 0 : hookParams.step, context] }, { afterFn: afterFn, afterFnArgs: (context) => [hookParams === null || hookParams === void 0 ? void 0 : hookParams.step, context] }, cid, retryTest);
        };
    }
}
exports.CucumberAdapter = CucumberAdapter;
const _CucumberAdapter = CucumberAdapter;
const adapterFactory = {};
exports.adapterFactory = adapterFactory;
/**
 * tested by smoke tests
 */
/* istanbul ignore next */
adapterFactory.init = async function (...args) {
    // @ts-ignore just passing through args
    const adapter = new _CucumberAdapter(...args);
    const instance = await adapter.init();
    return instance;
};
exports.default = adapterFactory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGdEQUF1QjtBQUN2QixtQ0FBcUM7QUFFckMsc0RBQTZCO0FBQzdCLHNEQUE0QjtBQUM1QixnREFBdUI7QUFFdkIsNkRBQThDO0FBQzlDLHNHQUE2RTtBQUM3RSx5SEFBOEY7QUFJOUYsaURBQWdEO0FBRWhELHVDQUFpRTtBQUdqRSwwREFBeUM7QUFDekMsMkNBQTBDO0FBRTFDLG1DQUEwQztBQUUxQyxNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsc0JBQVcsQ0FBQTtBQUVwQyxNQUFNLGVBQWU7SUFtQmpCLFlBQ1ksSUFBWSxFQUNaLE9BQTJCLEVBQzNCLE1BQWdCLEVBQ2hCLGFBQTRDLEVBQzVDLFNBQXVCO1FBSnZCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFVO1FBQ2hCLGtCQUFhLEdBQWIsYUFBYSxDQUErQjtRQUM1QyxjQUFTLEdBQVQsU0FBUyxDQUFjO1FBdkIzQixTQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLFdBQU0sR0FBRyxZQUFZLEVBQUUsQ0FBQTtRQXdCM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSx3QkFBWSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBeUMsQ0FBQyxDQUFBO1FBQzVHLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO1FBQ3JCLElBQUksQ0FBQyxnQ0FBZ0MsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLCtCQUErQixJQUFJLEVBQUUsQ0FBQTtRQUMxRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxxQkFBWSxFQUFFLENBQUE7UUFDM0MsSUFBSSxDQUFDLG1CQUFt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