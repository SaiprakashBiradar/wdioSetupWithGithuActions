"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.addKeywordToStep = exports.filterPickles = exports.setUserHookNames = exports.buildStepPayload = exports.getTestStepTitle = exports.getFeatureId = exports.getStepType = exports.formatMessage = exports.createStepArgument = void 0;
const path_1 = __importDefault(require("path"));
const utils_1 = require("@wdio/utils");
const logger_1 = __importDefault(require("@wdio/logger"));
const constants_1 = require("./constants");
const log = logger_1.default('@wdio/cucumber-framework:utils');
/**
 * NOTE: this function is exported for testing only
 */
function createStepArgument({ argument }) {
    var _a;
    if (!argument) {
        return undefined;
    }
    if (argument.dataTable) {
        return {
            rows: (_a = argument.dataTable.rows) === null || _a === void 0 ? void 0 : _a.map((row) => {
                var _a;
                return ({
                    cells: (_a = row.cells) === null || _a === void 0 ? void 0 : _a.map((cell) => cell.value)
                });
            })
        };
    }
    if (argument.docString) {
        return argument.docString.content;
    }
    return undefined;
}
exports.createStepArgument = createStepArgument;
/**
 * format message
 * @param {object} message { type: string, payload: object }
 */
function formatMessage({ payload = {} }) {
    let content = { ...payload };
    /**
     * need to convert Error to plain object, otherwise it is lost on process.send
     */
    if (payload.error && (payload.error.message || payload.error.stack)) {
        const { name, message, stack } = payload.error;
        content.error = { name, message, stack };
    }
    if (payload.title && payload.parent) {
        content.fullTitle = `${payload.parent}: ${payload.title}`;
    }
    return content;
}
exports.formatMessage = formatMessage;
var StepType;
(function (StepType) {
    StepType["hook"] = "hook";
    StepType["test"] = "test";
})(StepType || (StepType = {}));
/**
 * Get step type
 * @param {string} type `Step` or `Hook`
 */
function getStepType(step) {
    return step.hookId ? StepType.hook : StepType.test;
}
exports.getStepType = getStepType;
function getFeatureId(uri, feature) {
    var _a, _b;
    return `${path_1.default.basename(uri)}:${(_a = feature.location) === null || _a === void 0 ? void 0 : _a.line}:${(_b = feature.location) === null || _b === void 0 ? void 0 : _b.column}`;
}
exports.getFeatureId = getFeatureId;
/**
 * Builds test title from step keyword and text
 * @param {string} keyword
 * @param {string} text
 * @param {string} type
 */
function getTestStepTitle(keyword = '', text = '', type) {
    const title = (!text && type.toLowerCase() !== 'hook') ? 'Undefined Step' : text;
    return `${keyword.trim()} ${title.trim()}`.trim();
}
exports.getTestStepTitle = getTestStepTitle;
/**
 * build payload for test/hook event
 */
function buildStepPayload(uri, feature, scenario, step, params) {
    return {
        uid: step.id,
        // @ts-ignore
        title: getTestStepTitle(step.keyword, step.text, params.type),
        parent: scenario.id,
        argument: createStepArgument(step),
        file: uri,
        tags: scenario.tags,
        featureName: feature.name,
        scenarioName: scenario.name,
        ...params
    };
}
exports.buildStepPayload = buildStepPayload;
/**
 * wrap every user defined hook with function named `userHookFn`
 * to identify later on is function a step, user hook or wdio hook.
 * @param {object} options `Cucumber.supportCodeLibraryBuilder.options`
 */
function setUserHookNames(options) {
    constants_1.CUCUMBER_HOOK_DEFINITION_TYPES.forEach(hookName => {
        options[hookName].forEach((testRunHookDefinition) => {
            const hookFn = testRunHookDefinition.code;
            if (!hookFn.name.startsWith('wdioHook')) {
                const userHookAsyncFn = async function (...args) {
                    return hookFn.apply(this, args);
                };
                const userHookFn = function (...args) {
                    return hookFn.apply(this, args);
                };
                testRunHookDefinition.code = (utils_1.isFunctionAsync(hookFn)) ? userHookAsyncFn : userHookFn;
            }
        });
    });
}
exports.setUserHookNames = setUserHookNames;
/**
 * Returns true/false if testCase should be kept for current capabilities
 * according to tag in the syntax  @skip([conditions])
 * For example "@skip(browserName=firefox)" or "@skip(browserName=chrome,platform=/.+n?x/)"
 * @param {*} testCase
 */
function filterPickles(capabilities, pickle) {
    const skipTag = /^@skip\((.*)\)$/;
    const match = (value, expr) => {
        if (Array.isArray(expr)) {
            return expr.indexOf(value) >= 0;
        }
        else if (expr instanceof RegExp) {
            return expr.test(value);
        }
        return (expr && ('' + expr).toLowerCase()) === (value && ('' + value).toLowerCase());
    };
    const parse = (skipExpr) => skipExpr.split(';').reduce((acc, splitItem) => {
        const pos = splitItem.indexOf('=');
        if (pos > 0) {
            try {
                acc[splitItem.substring(0, pos)] = eval(splitItem.substring(pos + 1));
            }
            catch (e) {
                log.error(`Couldn't use tag "${splitItem}" for filtering because it is malformed`);
            }
        }
        return acc;
    }, {});
    return !(pickle && pickle.tags && pickle.tags
        .map(p => { var _a; return (_a = p.name) === null || _a === void 0 ? void 0 : _a.match(skipTag); })
        .filter(Boolean)
        .map(m => parse(m[1]))
        .find((filter) => Object.keys(filter)
        .every((key) => match(capabilities[key], filter[key]))));
}
exports.filterPickles = filterPickles;
/**
 * The reporters need to have the keywords, like `Given|When|Then`. They are NOT available
 * on the scenario, they ARE on the feature.
 * This will aad them
 */
function addKeywordToStep(steps, feature) {
    return steps.map(step => {
        // Steps without a astNodeIds are hooks
        if (step.astNodeIds && step.astNodeIds.length > 0 && feature.children) {
            // Points to the AST node locations of the pickle. The last one represents the unique id of the pickle.
            // A pickle constructed from Examples will have the first id originating from the Scenario AST node, and
            // the second from the TableRow AST node.
            // See https://github.com/cucumber/cucumber/blob/master/messages/messages.md
            const astNodeId = step.astNodeIds[0];
            feature.children.find((child) => 
            // @ts-ignore
            child[Object.keys(child)[0]].steps.find((featureScenarioStep) => {
                if (featureScenarioStep.id === astNodeId.toString()) {
                    step.keyword = featureScenarioStep.keyword;
                }
                return;
            }));
            return step;
        }
        return step;
    });
}
exports.addKeywordToStep = addKeywordToStep;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsZ0RBQXVCO0FBRXZCLHVDQUE2QztBQUM3QywwREFBaUM7QUFPakMsMkNBQTBFO0FBRzFFLE1BQU0sR0FBRyxHQUFHLGdCQUFNLENBQUMsZ0NBQWdDLENBQUMsQ0FBQTtBQUtwRDs7R0FFRztBQUNILFNBQWdCLGtCQUFrQixDQUFFLEVBQUUsUUFBUSxFQUErQjs7SUFDekUsSUFBSSxDQUFDLFFBQVEsRUFBRTtRQUNYLE9BQU8sU0FBUyxDQUFBO0tBQ25CO0lBRUQsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFO1FBQ3BCLE9BQU87WUFDSCxJQUFJLFFBQUUsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLDBDQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQW9CLEVBQUUsRUFBRTs7Z0JBQUMsT0FBQSxDQUN6RDtvQkFDSSxLQUFLLFFBQUUsR0FBRyxDQUFDLEtBQUssMENBQUUsR0FBRyxDQUFDLENBQUMsSUFBc0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztpQkFDaEUsQ0FDSixDQUFBO2FBQUEsQ0FBQztTQUNMLENBQUE7S0FDSjtJQUVELElBQUksUUFBUSxDQUFDLFNBQVMsRUFBRTtRQUNwQixPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFBO0tBQ3BDO0lBRUQsT0FBTyxTQUFTLENBQUE7QUFDcEIsQ0FBQztBQXBCRCxnREFvQkM7QUFFRDs7O0dBR0c7QUFDSCxTQUFnQixhQUFhLENBQUUsRUFBRSxPQUFPLEdBQUcsRUFBRSxFQUFPO0lBQ2hELElBQUksT0FBTyxHQUFHLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQTtJQUU1Qjs7T0FFRztJQUNILElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENB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